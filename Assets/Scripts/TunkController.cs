using System;
using UnityEngine;
using UnityEngine.InputSystem;

public class TunkController : Character
{
    public static event Action<TunkController> OnPlayerDied;
    [SerializeField] private BulletShoot _bulletShoot;  // BulletShootコンポーネント
    [SerializeField] private Transform _turret;

    [SerializeField] private string _moveActionName = "Move";
    [SerializeField] private string _shootActionName = "Shoot";
    public float _moveSpeed = 5f; // タンクの移動速度
    public float _turnSpeed = 100f;   // タンクの回転速度
    public float _turretTurnSpeed = 180f; // 砲塔の回転速度

    public PlayerType playerType;    // プレイヤーのタイプ

    private PlayerInput _playerInput;
    private Transform _firePoint;//Transformはpriveteにする
    private State _currentState = State.Idle; // プレイヤーの現在の状態
    private bool isInvulnerable = false; //アイテム取得時に 無敵true になる
    private Animator _animator;
    private Rigidbody _rb;

    protected override void Start()
    {
        base.Start(); // StartではなくAwakeを呼ぶ
        _playerInput = GetComponent<PlayerInput>();
        _playerInput.notificationBehavior = PlayerNotifications.InvokeUnityEvents;
        // Player 1用またはPlayer 2用のアクションマップを設定
        if (playerType == PlayerType.Player1)
        {
            _playerInput.SwitchCurrentActionMap("Player");
        }
        else if (playerType == PlayerType.Player2)
        {
            _playerInput.SwitchCurrentActionMap("Player");
        }
        // PlayerInputのイベント登録
        _playerInput.actions[_shootActionName].performed += HandleShooting;
        _playerInput.actions["RocketShoot"].performed += HandleShooting;
        _playerInput.actions["HomingShoot"].performed += HandleShooting;

        _animator = GetComponentInChildren<Animator>();
        _rb = GetComponent<Rigidbody>();

        if (!_playerInput.actions.Contains(_playerInput.actions[_shootActionName]))
        {
            Debug.LogError($"Action {_shootActionName} is not found in PlayerInput.");
        }

        GameManager.Instance.RegisterPlayer(this);
    }

    private void Update()
    {
        HandleMovement();
        HandleTurretRotation();
    }
    public void HandleMovement()
    {
        // ゲームパッドの移動入力を取得
        Vector2 moveInput = _playerInput.actions[_shootActionName].ReadValue<Vector2>();
        float moveDirection = moveInput.y;  // 前後移動
        float turnDirection = moveInput.x;  // 左右回転

        MoveTank(moveDirection, turnDirection);

        // 状態を更新
        _currentState = moveDirection != 0
            ? _currentState | State.Moving
            : _currentState & ~State.Moving;
    }

    private void MoveTank(float moveInput, float turnInput)
    {
        Vector3 moveDirection = transform.forward * moveInput * _moveSpeed * Time.deltaTime;
        transform.position += moveDirection;
        //Vector3 newPosition = _rb.position + moveDirection;
        //_rb.MovePosition(newPosition);

        //float turnAmount = turnInput * _turnSpeed * Time.deltaTime;
        float turnAmount = turnInput * 100f * Time.deltaTime;
        transform.Rotate(0f, turnAmount, 0f);
        //Quaternion turnRotation = Quaternion.Euler(0f, turnAmount, 0f);
        //_rb.MoveRotation(_rb.rotation * turnRotation);
    }//移動処理
    private void HandleTurretRotation()
    {
        if (_turret == null) return;
        // 右スティックの入力で砲塔の回転
        Vector2 moveInput = _playerInput.actions["TurretMove"].ReadValue<Vector2>();
        float turretTurnInput = moveInput.x;  // 左右（旋回）

        float turretTurnAmount = turretTurnInput * _turretTurnSpeed * Time.deltaTime;
        //if (moveInput.sqrMagnitude > 0.1f)
        //{
        //    // 入力方向から角度を計算
        //    float angle = Mathf.Atan2(moveInput.x, moveInput.y) * Mathf.Rad2Deg;
        //    Quaternion targetRotation = Quaternion.Euler(0, angle, 0);
        //    _turret.rotation = Quaternion.RotateTowards(_turret.rotation, targetRotation, _turretTurnSpeed * Time.deltaTime);
        //}
        _turret.Rotate(0f, turretTurnAmount, 0f);
    }

    void HandleShooting(InputAction.CallbackContext context)
    {
        if (GameManager.Instance.currentState != GameState.Playing)
        {
            Debug.Log("ゲーム中じゃないので発射できません！！");
            return;
        }

        Quaternion rotation = default;
        if (_bulletShoot == null) return; // 処理を中断
        IShootStrategy strategy = null;
        string actionName = context.action.name;

        // プレイヤーの入力に応じて通常弾を発射
        if (actionName == _shootActionName)
        {
            strategy = new NormalShotStrategy();
            TriggerShootAnimation("shoot");
        }
        // ロケット弾の発射（RocketShootアクションに応じて処理）
        else if (actionName == "RocketShoot")
        {
            strategy = new RocketShotStrategy();
            TriggerShootAnimation("rocketShoot");
        }
        //ホーミング弾が発射
        else if (actionName == "HomingShoot")
        {
            strategy = new HomingShotStrategy();
            TriggerShootAnimation("shoot");
        }

        if (strategy != null)
        {
            _bulletShoot.SetStrategy(strategy);
            _bulletShoot.ShootByStrategy(playerType, transform.forward, transform.rotation);
        }
    }

    private void TriggerShootAnimation(string triggerName)
    {
        _animator.SetTrigger(triggerName);
        _currentState |= State.Shooting;
    }

    public override void TakeDamage(float damage)
    {
        Debug.Log($"{gameObject.name} before damage: {currentHealth}");
        currentHealth -= damage;
        if (hpBar == null)
        {
            Debug.LogError("HPバーがアタッチされていません！");
        }
        hpBar.UpdateHP(currentHealth, maxHealth);

        if (IsInvulnerable)
        {
            Debug.Log("無敵状態のためダメージを受けない！");
            return;
        }
        if (currentHealth <= 0)
        {
            currentHealth = 0;  // HPが負の値にならないようにする
            Die();
        }
        _currentState = State.Dead;
    }

    public bool IsInvulnerable
    {
        get { return isInvulnerable; }
        set
        {
            isInvulnerable = value;
            Debug.Log(isInvulnerable ? "無敵モード ON!" : "無敵モード OFF!");
        }
    }
    protected override void Die()
    {
        Debug.Log($"{gameObject.name} has died.");
        GameManager.Instance.RemovePlayer(this);
        OnPlayerDied?.Invoke(this);
        string winner = gameObject.name == "TankBlue(Player)" ? "TankRed(Enemy)" : "TankBlue(Player)";
        FindAnyObjectByType<GameManager>().CheckWinner(winner);
        base.Die();
    }
}
